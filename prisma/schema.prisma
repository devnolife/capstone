// Prisma Schema for Capstone Project Management System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Role {
  MAHASISWA
  DOSEN_PENGUJI
  ADMIN
}

enum ProjectStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  REVISION_NEEDED
  APPROVED
  REJECTED
}

enum DocumentType {
  PROPOSAL
  BAB_1
  BAB_2
  BAB_3
  BAB_4
  BAB_5
  FINAL_REPORT
  PRESENTATION
  SOURCE_CODE
  OTHER
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// ==================== MODELS ====================

model User {
  id             String    @id @default(cuid())
  username       String    @unique  // NIM untuk mahasiswa, NIP untuk dosen, username untuk admin
  name           String
  password       String    // Required for all users
  role           Role      @default(MAHASISWA)
  avatarUrl      String?
  githubId       String?   @unique
  githubUsername String?
  githubToken    String?   // Encrypted GitHub access token
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  projects          Project[]           @relation("ProjectOwner")
  reviews           Review[]            @relation("Reviewer")
  notifications     Notification[]
  assignedProjects  ProjectAssignment[]

  @@map("users")
}

model Project {
  id             String        @id @default(cuid())
  title          String
  description    String?       @db.Text
  status         ProjectStatus @default(DRAFT)
  githubRepoUrl  String?
  githubRepoName String?
  semester       String        // e.g., "Ganjil 2024/2025"
  tahunAkademik  String        // e.g., "2024/2025"
  submittedAt    DateTime?     // When project was submitted for review
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  mahasiswaId String
  mahasiswa   User                @relation("ProjectOwner", fields: [mahasiswaId], references: [id], onDelete: Cascade)
  documents   Document[]
  reviews     Review[]
  assignments ProjectAssignment[]
  requirements ProjectRequirement[]

  @@map("projects")
}

model ProjectAssignment {
  id         String   @id @default(cuid())
  projectId  String
  dosenId    String
  assignedAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dosen   User    @relation(fields: [dosenId], references: [id], onDelete: Cascade)

  @@unique([projectId, dosenId])
  @@map("project_assignments")
}

model Document {
  id         String       @id @default(cuid())
  projectId  String
  type       DocumentType
  fileName   String
  filePath   String
  fileSize   Int          // in bytes
  mimeType   String
  uploadedAt DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Review {
  id             String       @id @default(cuid())
  projectId      String
  reviewerId     String
  status         ReviewStatus @default(PENDING)
  overallScore   Int?         // 0-100
  overallComment String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  completedAt    DateTime?

  // Relations
  project  Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer User            @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  comments ReviewComment[]
  scores   ReviewScore[]

  @@unique([projectId, reviewerId])
  @@map("reviews")
}

model ReviewComment {
  id         String   @id @default(cuid())
  reviewId   String
  content    String   @db.Text
  filePath   String?  // For inline code review (e.g., "src/app/page.tsx")
  lineNumber Int?     // For inline code review
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_comments")
}

model RubrikPenilaian {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  kategori    String   // e.g., "Kualitas Kode", "Dokumentasi", "Presentasi"
  bobotMax    Int      // Max score for this category (e.g., 20)
  urutan      Int      @default(0) // Order of display
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  scores ReviewScore[]

  @@map("rubrik_penilaian")
}

model ReviewScore {
  id        String   @id @default(cuid())
  reviewId  String
  rubrikId  String
  score     Int      // Actual score given
  feedback  String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  review Review          @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  rubrik RubrikPenilaian @relation(fields: [rubrikId], references: [id], onDelete: Cascade)

  @@unique([reviewId, rubrikId])
  @@map("review_scores")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  type      String   // e.g., "review", "submission", "assignment", "system"
  link      String?  // URL to navigate when clicked
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ==================== SEMESTER CONFIGURATION ====================

model Semester {
  id          String   @id @default(cuid())
  name        String   // e.g., "Ganjil 2024/2025"
  tahunAkademik String // e.g., "2024/2025"
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("semesters")
}

// ==================== PROJECT REQUIREMENTS ====================

model ProjectRequirement {
  id          String   @id @default(cuid())
  projectId   String
  category    String   // e.g., "judul", "tujuan", "metodologi", etc.
  content     String   @db.Text
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, category])
  @@map("project_requirements")
}
