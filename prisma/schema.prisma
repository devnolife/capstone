// Prisma Schema for Capstone Project Management System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Role {
  MAHASISWA
  DOSEN_PENGUJI
  ADMIN
}

enum ProjectStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  REVISION_NEEDED
  APPROVED
  REJECTED
}

enum DocumentType {
  PROPOSAL
  BAB_1
  BAB_2
  BAB_3
  BAB_4
  BAB_5
  FINAL_REPORT
  PRESENTATION
  SOURCE_CODE
  OTHER
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// ==================== MODELS ====================

model User {
  id             String    @id @default(cuid())
  username       String    @unique  // NIM untuk mahasiswa, NIP untuk dosen, username untuk admin
  email          String?   @unique  // Email untuk OAuth providers
  emailVerified  DateTime? // Required by NextAuth adapter
  name           String
  password       String?   // Nullable for OAuth users
  role           Role      @default(MAHASISWA)
  image          String?   // For NextAuth compatibility (avatar URL)
  githubId       String?   @unique
  githubUsername String?
  githubToken    String?   // Encrypted GitHub access token
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  projects          Project[]           @relation("ProjectOwner")
  reviews           Review[]            @relation("Reviewer")
  notifications     Notification[]
  assignedProjects  ProjectAssignment[]
  accounts          Account[]

  @@map("users")
}

// NextAuth Account model for OAuth providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Project {
  id             String        @id @default(cuid())
  title          String
  description    String?       @db.Text
  status         ProjectStatus @default(DRAFT)
  
  // GitHub - Repo Mahasiswa
  githubRepoUrl  String?
  githubRepoName String?
  
  // GitHub - Repo di Organization (setelah fork)
  orgRepoUrl     String?       // URL repo di org setelah fork
  orgRepoName    String?       // Nama repo di org
  forkedAt       DateTime?     // Kapan di-fork ke org
  
  semester       String        // e.g., "Ganjil 2024/2025"
  tahunAkademik  String        // e.g., "2024/2025"
  submittedAt    DateTime?     // When project was submitted for review
  approvedAt     DateTime?     // When project was approved
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  mahasiswaId  String
  mahasiswa    User                 @relation("ProjectOwner", fields: [mahasiswaId], references: [id], onDelete: Cascade)
  documents    Document[]
  reviews      Review[]
  assignments  ProjectAssignment[]
  requirements ProjectRequirements?
  members      ProjectMember[]

  @@map("projects")
}

// Project Team Members (via GitHub)
model ProjectMember {
  id              String   @id @default(cuid())
  projectId       String
  githubUsername  String
  githubId        String?
  githubAvatarUrl String?
  name            String?
  role            String   @default("member") // "leader" | "member"
  addedAt         DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, githubUsername])
  @@map("project_members")
}

model ProjectAssignment {
  id         String   @id @default(cuid())
  projectId  String
  dosenId    String
  assignedAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dosen   User    @relation(fields: [dosenId], references: [id], onDelete: Cascade)

  @@unique([projectId, dosenId])
  @@map("project_assignments")
}

model Document {
  id         String       @id @default(cuid())
  projectId  String
  type       DocumentType
  fileName   String
  filePath   String
  fileSize   Int          // in bytes
  mimeType   String
  uploadedAt DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Review {
  id             String       @id @default(cuid())
  projectId      String
  reviewerId     String
  status         ReviewStatus @default(PENDING)
  overallScore   Int?         // 0-100
  overallComment String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  completedAt    DateTime?

  // Relations
  project  Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer User            @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  comments ReviewComment[]
  scores   ReviewScore[]

  @@unique([projectId, reviewerId])
  @@map("reviews")
}

model ReviewComment {
  id         String   @id @default(cuid())
  reviewId   String
  content    String   @db.Text
  filePath   String?  // For inline code review (e.g., "src/app/page.tsx")
  lineNumber Int?     // For inline code review
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_comments")
}

model RubrikPenilaian {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  kategori    String   // e.g., "Kualitas Kode", "Dokumentasi", "Presentasi"
  bobotMax    Int      // Max score for this category (e.g., 20)
  urutan      Int      @default(0) // Order of display
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  scores ReviewScore[]

  @@map("rubrik_penilaian")
}

model ReviewScore {
  id        String   @id @default(cuid())
  reviewId  String
  rubrikId  String
  score     Int      // Actual score given
  feedback  String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  review Review          @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  rubrik RubrikPenilaian @relation(fields: [rubrikId], references: [id], onDelete: Cascade)

  @@unique([reviewId, rubrikId])
  @@map("review_scores")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  type      String   // e.g., "review", "submission", "assignment", "system"
  link      String?  // URL to navigate when clicked
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ==================== SEMESTER CONFIGURATION ====================

model Semester {
  id          String   @id @default(cuid())
  name        String   // e.g., "Ganjil 2024/2025"
  tahunAkademik String // e.g., "2024/2025"
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("semesters")
}

// ==================== PROJECT REQUIREMENTS (Persyaratan Proyek) ====================

model ProjectRequirements {
  id        String   @id @default(cuid())
  projectId String   @unique // One requirements per project

  // ========== INFORMASI DASAR ==========
  judulProyek          String?   // Text input - Judul proyek
  targetPengguna       String?   @db.Text // Untuk siapa aplikasi/sistem ini
  latarBelakangMasalah String?   @db.Text // Mengapa proyek ini perlu dibuat
  tujuanProyek         String?   @db.Text // Apa yang ingin dicapai
  manfaatProyek        String?   @db.Text // Keuntungan yang didapat

  // ========== ASPEK AKADEMIK ==========
  integrasiMatakuliah  String?   @db.Text // Integrasi konsep dari mata kuliah yang relevan
  metodologi           String?   @db.Text // Metodologi pengembangan (Agile, Waterfall, dll)
  penulisanLaporan     String?   @db.Text // Rencana format dan struktur laporan

  // ========== TEKNIS & IMPLEMENTASI ==========
  ruangLingkup         String?   @db.Text // Batasan dan cakupan proyek
  sumberDayaBatasan    String?   @db.Text // Sumber daya & batasan (waktu, anggaran, akses data)
  teknologi            String?   @db.Text // Stack/tools yang dipakai
  fiturUtama           String?   @db.Text // Daftar fitur yang akan dibuat

  // ========== ANALISIS & EVALUASI ==========
  analisisTemuan       String?   @db.Text // Rencana analisis dan temuan yang diharapkan
  presentasiUjian      String?   @db.Text // Rencana presentasi dan persiapan ujian
  stakeholder          String?   @db.Text // Keterlibatan stakeholder
  kepatuhanEtika       String?   @db.Text // Aspek etika dan penanganan data

  // ========== TIMELINE ==========
  timeline             String?   @db.Text // Deskripsi rencana pengerjaan
  kerangkaWaktu        String?   @db.Text // Jadwal terstruktur per tahapan
  deadlineDate         DateTime? // Tanggal deadline proyek

  // Metadata
  completionPercent Int      @default(0) // 0-100
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_requirements")
}
