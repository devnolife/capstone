// Prisma Schema for Capstone Project Management System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Role {
  MAHASISWA
  DOSEN_PENGUJI
  ADMIN
}

enum ProjectStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  REVISION_NEEDED
  APPROVED
  REJECTED
}

enum DocumentType {
  PRESENTATION
  SOURCE_CODE
  OTHER
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum StakeholderDocumentType {
  SIGNATURE // Tanda tangan stakeholder
  PHOTO // Foto stakeholder/kegiatan
  AGREEMENT_LETTER // Surat persetujuan
  ID_CARD // Kartu identitas
  SCREENSHOT // Screenshot aplikasi/sistem
  SUPPORTING_DOCUMENT // Dokumen pelengkap
  OTHER // Dokumen lainnya
}

// ==================== MODELS ====================

model User {
  id             String    @id @default(cuid())
  username       String    @unique // NIM untuk mahasiswa, NIP untuk dosen, username untuk admin
  email          String?   @unique // Email untuk OAuth providers
  emailVerified  DateTime? // Required by NextAuth adapter
  name           String
  password       String? // Nullable for OAuth users (bcrypt hash for fallback)
  role           Role      @default(MAHASISWA)
  image          String? // For NextAuth compatibility (avatar URL from OAuth)
  profilePhoto   String? // Custom uploaded profile photo URL
  githubId       String?   @unique
  githubUsername String?
  githubToken    String? // Encrypted GitHub access token
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // SIMAK Integration Fields
  nim            String?   @unique // NIM dari SIMAK (untuk mahasiswa)
  nip            String?   @unique // NIP untuk dosen
  phone          String?            // No HP
  prodi          String?            // Program studi
  simakPhoto     String?            // URL foto dari SIMAK
  simakValidated Boolean   @default(false) // Apakah akun sudah tervalidasi via SIMAK
  simakLastSync  DateTime?          // Terakhir sync data dari SIMAK

  // Relations
  projects            Project[]           @relation("ProjectOwner")
  reviews             Review[]            @relation("Reviewer")
  notifications       Notification[]
  assignedProjects    ProjectAssignment[]
  accounts            Account[]
  teamMemberships     ProjectMember[]     @relation("TeamMember")
  invitationsSent     TeamInvitation[]    @relation("InvitationsSent")
  invitationsReceived TeamInvitation[]    @relation("InvitationsReceived")

  @@map("users")
}

// NextAuth Account model for OAuth providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Project {
  id             String        @id @default(cuid())
  title          String
  description    String?       @db.Text
  status         ProjectStatus @default(DRAFT)
  githubRepoUrl  String?
  githubRepoName String?
  productionUrl  String?       // URL production/demo aplikasi
  semester       String        @default("Ganjil")
  tahunAkademik  String        @default("2024/2025")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  submittedAt    DateTime?

  // Owner
  mahasiswaId String
  mahasiswa   User   @relation("ProjectOwner", fields: [mahasiswaId], references: [id])

  // Relations
  documents             Document[]
  reviews               Review[]
  assignments           ProjectAssignment[]
  members               ProjectMember[]
  invitations           TeamInvitation[]
  requirements          ProjectRequirements?
  stakeholderDocuments  StakeholderDocument[]

  @@map("projects")
}

// Tim Project / Anggota Kelompok
model ProjectMember {
  id              String   @id @default(cuid())
  projectId       String
  userId          String?  // Null jika belum terhubung dengan akun
  githubUsername  String?  // GitHub username untuk kolaborator eksternal
  githubAvatarUrl String?  // Avatar URL dari GitHub
  name            String?  // Nama manual jika tidak ada akun
  role            String   @default("member") // "leader" atau "member"
  joinedAt        DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User?   @relation("TeamMember", fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@unique([projectId, githubUsername])
  @@map("project_members")
}

// Undangan untuk bergabung tim
model TeamInvitation {
  id         String   @id @default(cuid())
  projectId  String
  inviterId  String   // User yang mengundang
  inviteeId  String   // User yang diundang
  status     String   @default("pending") // "pending", "accepted", "rejected"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  expiresAt  DateTime // Kapan undangan kadaluarsa

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter User    @relation("InvitationsSent", fields: [inviterId], references: [id])
  invitee User    @relation("InvitationsReceived", fields: [inviteeId], references: [id])

  @@unique([projectId, inviteeId])
  @@map("team_invitations")
}

// Persyaratan Project (form lengkap)
model ProjectRequirements {
  id                   String   @id @default(cuid())
  projectId            String   @unique
  
  // Basic Info
  judulProyek          String?  @db.Text
  targetPengguna       String?  @db.Text
  latarBelakangMasalah String?  @db.Text
  tujuanProyek         String?  @db.Text
  manfaatProyek        String?  @db.Text
  
  // Academic
  integrasiMatakuliah  String?  @db.Text
  metodologi           String?  @db.Text
  penulisanLaporan     String?  @db.Text
  
  // Technical
  ruangLingkup         String?  @db.Text
  sumberDayaBatasan    String?  @db.Text
  teknologi            String?  @db.Text
  fiturUtama           String?  @db.Text
  
  // Analysis
  analisisTemuan       String?  @db.Text
  presentasiUjian      String?  @db.Text
  stakeholder          String?  @db.Text
  kepatuhanEtika       String?  @db.Text
  
  // Timeline
  timeline             String?  @db.Text
  kerangkaWaktu        String?  @db.Text
  deadlineDate         DateTime?
  
  // Completion tracking
  completionPercent    Int      @default(0)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_requirements")
}

// Dokumen Stakeholder
model StakeholderDocument {
  id              String                  @id @default(cuid())
  projectId       String
  stakeholderName String                  // Nama stakeholder
  stakeholderRole String?                 // Jabatan/peran stakeholder
  organization    String?                 // Organisasi/instansi
  type            StakeholderDocumentType @default(OTHER)
  fileName        String
  fileUrl         String
  fileSize        Int                     // dalam bytes
  description     String?                 @db.Text
  uploadedAt      DateTime                @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("stakeholder_documents")
}

model Document {
  id         String       @id @default(cuid())
  projectId  String
  type       DocumentType
  fileName   String
  filePath   String
  fileSize   Int
  uploadedAt DateTime     @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Review {
  id             String       @id @default(cuid())
  projectId      String
  reviewerId     String
  status         ReviewStatus @default(PENDING)
  overallScore   Float?
  overallComment String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  completedAt    DateTime?

  project  Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer User            @relation("Reviewer", fields: [reviewerId], references: [id])
  scores   ReviewScore[]
  comments ReviewComment[]

  @@map("reviews")
}

model ReviewScore {
  id        String @id @default(cuid())
  reviewId  String
  rubrikId  String
  score     Float
  maxScore  Float
  comment   String? @db.Text

  review Review          @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  rubrik RubrikPenilaian @relation(fields: [rubrikId], references: [id])

  @@unique([reviewId, rubrikId])
  @@map("review_scores")
}

model ReviewComment {
  id        String   @id @default(cuid())
  reviewId  String
  section   String // Bagian yang dikomentari (code, documentation, presentation, dll)
  filePath  String? // Path file jika komentar untuk kode
  lineStart Int? // Line awal jika komentar untuk kode
  lineEnd   Int? // Line akhir jika komentar untuk kode
  content   String   @db.Text
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_comments")
}

model RubrikPenilaian {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  kategori    String // "Teknis", "Dokumentasi", "Presentasi", "Umum"
  bobotMax    Float // Bobot maksimal (misal: 20, 25)
  isActive    Boolean @default(true)
  urutan      Int     @default(0) // Urutan tampil

  scores ReviewScore[]

  @@map("rubrik_penilaian")
}

model ProjectAssignment {
  id         String   @id @default(cuid())
  projectId  String
  dosenId    String
  assignedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dosen   User    @relation(fields: [dosenId], references: [id])

  @@unique([projectId, dosenId])
  @@map("project_assignments")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  type      String // "assignment", "review", "submission", "system"
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Semester {
  id            String   @id @default(cuid())
  name          String // "Ganjil 2024/2025"
  tahunAkademik String // "2024/2025"
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("semesters")
}
